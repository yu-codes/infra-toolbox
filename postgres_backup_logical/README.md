# PostgreSQL Logical Backup Service

åŸºæ–¼ Docker çš„ PostgreSQL **é‚è¼¯å‚™ä»½**æœå‹™ï¼Œä½¿ç”¨ PostgreSQL å®˜æ–¹å·¥å…· `pg_dump` / `pg_restore` é€²è¡Œå‚™ä»½é‚„åŸã€‚

---

## ğŸ” ç‚ºä»€éº¼ä½¿ç”¨ Shell è…³æœ¬è€Œé SQLï¼Ÿ

> **é€™æ˜¯æ¥­ç•Œæ¨™æº–åšæ³•ï¼Œéè‡ªå‰µæ–¹æ¡ˆã€‚**

### æ ¸å¿ƒæ¦‚å¿µï¼špg_dump æ˜¯ PostgreSQL å®˜æ–¹å‚™ä»½å·¥å…·

`pg_dump` æ˜¯ PostgreSQL å®˜æ–¹æä¾›çš„é‚è¼¯å‚™ä»½å·¥å…·ï¼Œ**ä¸æ˜¯ SQL èªå¥**ï¼Œè€Œæ˜¯ä¸€å€‹ç¨ç«‹çš„å‘½ä»¤åˆ—ç¨‹å¼ã€‚å®ƒçš„è¨­è¨ˆç›®çš„å°±æ˜¯ç”¨æ–¼è‡ªå‹•åŒ–å‚™ä»½è…³æœ¬ä¸­ã€‚

### ç‚ºä»€éº¼ä¸ç›´æ¥ç”¨ SQL å‚™ä»½ï¼Ÿ

| æ–¹å¼ | èªªæ˜ | å•é¡Œ |
|------|------|------|
| âŒ `COPY TO` | SQL å‘½ä»¤ï¼ŒåŒ¯å‡ºå–®ä¸€è¡¨æ ¼ | ç„¡æ³•å‚™ä»½ schemaã€ç´¢å¼•ã€æ¬Šé™ç­‰ |
| âŒ æ‰‹å¯« SQL | è‡ªå·±å¯« SELECT å°å‡º | ç„¡æ³•è™•ç†é—œè¯ã€åºåˆ—ã€è§¸ç™¼å™¨ |
| âœ… **pg_dump** | PostgreSQL å®˜æ–¹å·¥å…· | å®Œæ•´å‚™ä»½æ‰€æœ‰è³‡æ–™åº«ç‰©ä»¶ |

### pg_dump çš„å„ªå‹¢

```bash
# pg_dump è‡ªå‹•è™•ç†ä»¥ä¸‹æ‰€æœ‰å…§å®¹ï¼š
# - æ‰€æœ‰è¡¨æ ¼çš„çµæ§‹ (CREATE TABLE)
# - æ‰€æœ‰è¡¨æ ¼çš„è³‡æ–™ (INSERT/COPY)
# - ç´¢å¼• (INDEX)
# - ä¸»éµ/å¤–éµç´„æŸ (CONSTRAINTS)
# - åºåˆ— (SEQUENCES)
# - è¦–åœ– (VIEWS)
# - å‡½æ•¸å’Œè§¸ç™¼å™¨ (FUNCTIONS, TRIGGERS)
# - æ¬Šé™è¨­å®š (GRANT/REVOKE)
# - è€Œä¸”ä¿è­‰è³‡æ–™ä¸€è‡´æ€§ (ä½¿ç”¨äº¤æ˜“)
```

### å®˜æ–¹æ–‡ç»åƒè€ƒ

- [PostgreSQL pg_dump å®˜æ–¹æ–‡ä»¶](https://www.postgresql.org/docs/current/app-pgdump.html)
- [PostgreSQL Backup and Restore](https://www.postgresql.org/docs/current/backup-dump.html)

> *"pg_dump is a utility for backing up a PostgreSQL database. It makes consistent backups even if the database is being used concurrently."* â€” PostgreSQL Documentation

### æ¥­ç•Œå¯¦è¸

å¤§å‹ä¼æ¥­å’Œé›²ç«¯æœå‹™å•†éƒ½ä½¿ç”¨è…³æœ¬åŒ–çš„ pg_dumpï¼š

| æœå‹™/å…¬å¸ | å‚™ä»½æ–¹å¼ |
|-----------|----------|
| AWS RDS | å…§éƒ¨ä½¿ç”¨ pg_dump é€²è¡Œé‚è¼¯å‚™ä»½ |
| Google Cloud SQL | æä¾› pg_dump åŒ¯å‡ºåŠŸèƒ½ |
| Heroku | ä½¿ç”¨ pg_dump é€²è¡Œè³‡æ–™åº«å‚™ä»½ |
| GitLab | ä½¿ç”¨ pg_dump è…³æœ¬å‚™ä»½ PostgreSQL |

---

## ğŸ“‹ å‚™ä»½æ–¹å¼æ¯”è¼ƒ

| ç‰¹æ€§ | èªªæ˜ |
|------|------|
| å‚™ä»½å·¥å…· | `pg_dump` (PostgreSQL å®˜æ–¹å·¥å…·) |
| å‚™ä»½é¡å‹ | SQL æ–‡å­—æª”æˆ–è‡ªè¨‚æ ¼å¼ |
| å®Œæ•´å‚™ä»½ | âœ“ æ”¯æ´ |
| å¢é‡å‚™ä»½ | â–³ åƒ…æ™‚é–“æˆ³åˆ†é›¢ (éçœŸæ­£å¢é‡) |
| è·¨ç‰ˆæœ¬é‚„åŸ | âœ“ æ”¯æ´ |
| Point-in-Time Recovery | âœ— ä¸æ”¯æ´ (è«‹ä½¿ç”¨ç‰©ç†å‚™ä»½) |
| é¸æ“‡æ€§é‚„åŸ | âœ“ æ”¯æ´ (ç‰¹å®šè³‡æ–™è¡¨) |
| åŠ å¯†å‚™ä»½ | âœ“ æ”¯æ´ (å¤šç¨®ç®—æ³•å¯é¸) |
| é Docker PostgreSQL | âœ“ æ”¯æ´ |

## é©ç”¨å ´æ™¯

- âœ“ å°å‹åˆ°ä¸­å‹è³‡æ–™åº« (< 100GB)
- âœ“ éœ€è¦è·¨ PostgreSQL ç‰ˆæœ¬é‚„åŸ
- âœ“ éœ€è¦é¸æ“‡æ€§å‚™ä»½/é‚„åŸç‰¹å®šè³‡æ–™è¡¨
- âœ“ é–‹ç™¼/æ¸¬è©¦ç’°å¢ƒ
- âœ“ Docker æˆ–é Docker é‹è¡Œçš„ PostgreSQL
- â–³ å¤§å‹è³‡æ–™åº« (å‚™ä»½/é‚„åŸè¼ƒæ…¢)
- âœ— éœ€è¦ PITR (è«‹ä½¿ç”¨ç‰©ç†å‚™ä»½)

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

```bash
# 1. é…ç½®ç’°å¢ƒè®Šæ•¸
cp .env.example .env
# ç·¨è¼¯ .env è¨­å®šè³‡æ–™åº«é€£æ¥è³‡è¨Š

# 2. å»ºç«‹ç¶²è·¯ (é¦–æ¬¡)
docker network create infra-toolbox-network

# 3. å•Ÿå‹•æœå‹™
docker-compose up -d

# 4. åŸ·è¡Œå‚™ä»½
docker exec postgres-backup-logical /scripts/backup.sh full
```

---

## ğŸ”§ è…³æœ¬å·¥ä½œåŸç†è©³è§£

### backup.sh åšäº†ä»€éº¼ï¼Ÿ

```bash
#!/bin/sh
# è…³æœ¬åŸ·è¡Œæµç¨‹:

# 1. è¼‰å…¥ç’°å¢ƒè®Šæ•¸é…ç½®
export $(grep -v '^#' /scripts/config/.env | xargs)

# 2. é©—è­‰å¿…è¦é…ç½®
#    - æª¢æŸ¥ POSTGRES_DATABASE æ˜¯å¦è¨­å®š
#    - æª¢æŸ¥ POSTGRES_PASSWORD æ˜¯å¦è¨­å®š
#    - è‹¥å•Ÿç”¨åŠ å¯†ï¼Œæª¢æŸ¥ BACKUP_ENCRYPTION_PASSWORD

# 3. æ¸¬è©¦è³‡æ–™åº«é€£æ¥
psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USERNAME \
     -d $POSTGRES_DATABASE -c "SELECT 1;"

# 4. åŸ·è¡Œ pg_dump (PostgreSQL å®˜æ–¹å‚™ä»½å·¥å…·)
#    pg_dump æœƒç”¢ç”Ÿå®Œæ•´çš„ SQL é‚„åŸè…³æœ¬
pg_dump -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USERNAME \
        -d $POSTGRES_DATABASE --format=plain --no-owner --no-acl

# 5. å£“ç¸®å‚™ä»½æª”æ¡ˆ (å¯é¸)
#    ä½¿ç”¨ gzip æ¸›å°‘å‚™ä»½å¤§å°ï¼Œé€šå¸¸å¯å£“ç¸® 70-90%
... | gzip -9 > backup.sql.gz

# 6. åŠ å¯†å‚™ä»½æª”æ¡ˆ (å¯é¸)
#    ä½¿ç”¨ OpenSSL é€²è¡Œ AES-256 åŠ å¯†
... | openssl enc -aes-256-cbc -salt -pbkdf2 -pass pass:$PASSWORD

# 7. æ¸…ç†éæœŸå‚™ä»½
#    æ ¹æ“š RETENTION_DAYS è¨­å®šåˆªé™¤èˆŠå‚™ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +$RETENTION_DAYS -delete
```

### restore.sh åšäº†ä»€éº¼ï¼Ÿ

```bash
#!/bin/sh
# é‚„åŸæµç¨‹:

# 1. æª¢æ¸¬å‚™ä»½æª”æ¡ˆé¡å‹
#    æ ¹æ“šå‰¯æª”ååˆ¤æ–·: .sql / .sql.gz / .sql.enc / .sql.gz.enc

# 2. è§£å¯† (è‹¥å‚™ä»½å·²åŠ å¯†)
openssl enc -aes-256-cbc -d -pbkdf2 -pass pass:$PASSWORD -in backup.enc

# 3. è§£å£“ç¸® (è‹¥å‚™ä»½å·²å£“ç¸®)
gunzip -c backup.sql.gz

# 4. åŸ·è¡Œ psql é‚„åŸ (PostgreSQL å®˜æ–¹å·¥å…·)
#    psql æœƒåŸ·è¡Œå‚™ä»½æª”ä¸­çš„æ‰€æœ‰ SQL èªå¥
psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USERNAME \
     -d $POSTGRES_DATABASE -f backup.sql
```

### å‚™ä»½æª”æ¡ˆå…§å®¹ç¯„ä¾‹

pg_dump ç”¢ç”Ÿçš„ SQL æª”æ¡ˆåŒ…å«å®Œæ•´çš„è³‡æ–™åº«é‡å»ºèªå¥ï¼š

```sql
-- PostgreSQL database dump
-- Generated by pg_dump version 14.0

SET statement_timeout = 0;
SET client_encoding = 'UTF8';

-- å»ºç«‹è¡¨æ ¼çµæ§‹
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å»ºç«‹ç´¢å¼•
CREATE INDEX idx_users_email ON users(email);

-- æ’å…¥è³‡æ–™
COPY users (id, username, email, created_at) FROM stdin;
1	admin	admin@example.com	2024-01-01 00:00:00
2	user1	user1@example.com	2024-01-02 00:00:00
\.

-- é‡è¨­åºåˆ—
SELECT pg_catalog.setval('users_id_seq', 2, true);

-- è¨­å®šæ¬Šé™ (è‹¥æœ‰)
-- GRANT SELECT ON users TO readonly_user;
```

---

## ğŸ”Œ é€£æ¥æ¨¡å¼

### Docker å…§ PostgreSQL (é è¨­)

```env
POSTGRES_CONNECTION_MODE=docker
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
```

### å®¿ä¸»æ©Ÿä¸Šçš„ PostgreSQL

```env
POSTGRES_CONNECTION_MODE=host
POSTGRES_HOST=host.docker.internal
POSTGRES_PORT=5432
```

> **æ³¨æ„**ï¼šé€£æ¥é Docker PostgreSQL æ™‚ï¼Œç¢ºä¿ `pg_hba.conf` å…è¨±å¤–éƒ¨é€£æ¥ã€‚

---

## ğŸ“ å‚™ä»½å‘½ä»¤

```bash
# å®Œå…¨å‚™ä»½ (å»ºè­°æ¯é€±)
docker exec postgres-backup-logical /scripts/backup.sh full

# å¢é‡å‚™ä»½ (å»ºè­°æ¯æ—¥)
docker exec postgres-backup-logical /scripts/backup.sh incremental

# ç•°åœ°å‚™ä»½ (å»ºè­°æ¯æœˆ)
docker exec postgres-backup-logical /scripts/backup.sh remote

# åˆ—å‡ºå¯ç”¨å‚™ä»½
docker exec postgres-backup-logical /scripts/backup.sh list
```

## ğŸ”„ é‚„åŸå‘½ä»¤

```bash
# åˆ—å‡ºå¯ç”¨å‚™ä»½
docker exec postgres-backup-logical /scripts/restore.sh list

# é©—è­‰å‚™ä»½å®Œæ•´æ€§
docker exec postgres-backup-logical /scripts/restore.sh verify /backups/full/full_XXXXXXXX_XXXXXX.sql.gz

# é‚„åŸæŒ‡å®šå‚™ä»½
docker exec postgres-backup-logical /scripts/restore.sh restore /backups/full/full_XXXXXXXX_XXXXXX.sql.gz
```

---

## ğŸ” åŠ å¯†é…ç½®

### æ”¯æ´çš„åŠ å¯†ç®—æ³•

| ç®—æ³• | èªªæ˜ | å»ºè­° |
|------|------|------|
| `aes-256-cbc` | AES 256-bit CBC æ¨¡å¼ | é è¨­ï¼Œæœ€å»£æ³›æ”¯æ´ |
| `aes-128-cbc` | AES 128-bit CBC æ¨¡å¼ | è¼ƒå¿«ï¼Œå®‰å…¨æ€§ç•¥ä½ |
| `aes-192-cbc` | AES 192-bit CBC æ¨¡å¼ | ä¸­ç­‰ |
| `aes-256-gcm` | AES 256-bit GCM æ¨¡å¼ | **æ¨è–¦**ï¼Œèªè­‰åŠ å¯† |
| `chacha20-poly1305` | ChaCha20-Poly1305 | ç¾ä»£ç®—æ³•ï¼Œé«˜æ•ˆèƒ½ |

### é…ç½®ç¯„ä¾‹

```env
BACKUP_ENCRYPTION_ENABLED=true
BACKUP_ENCRYPTION_ALGORITHM=aes-256-gcm
BACKUP_ENCRYPTION_PASSWORD=your_secure_password_here
```

---

## ğŸ§ª å‚™ä»½èˆ‡é‚„åŸæ¼”ç·´æŒ‡å—

### æ¼”ç·´ç›®çš„

å®šæœŸé€²è¡Œå‚™ä»½é‚„åŸæ¼”ç·´å¯ä»¥ï¼š
- ç¢ºèªå‚™ä»½æª”æ¡ˆçš„å®Œæ•´æ€§
- é©—è­‰é‚„åŸæµç¨‹çš„æ­£ç¢ºæ€§
- ä¼°ç®—é‚„åŸæ‰€éœ€æ™‚é–“ (RTO)
- è¨“ç·´åœ˜éšŠæ‡‰å°ç½é›£æ¢å¾©

### æ¼”ç·´å‰æº–å‚™

```bash
# 1. ç¢ºèªå‚™ä»½æœå‹™é‹è¡Œä¸­
docker ps | grep postgres-backup-logical

# 2. ç¢ºèªæœ‰å¯ç”¨çš„å‚™ä»½æª”æ¡ˆ
docker exec postgres-backup-logical /scripts/backup.sh list

# 3. è¨˜éŒ„ç•¶å‰è³‡æ–™åº«ç‹€æ…‹ (ç”¨æ–¼é©—è­‰)
docker exec postgres psql -U postgres -d mydb -c "SELECT COUNT(*) FROM users;"
```

### æ¼”ç·´æ­¥é©Ÿä¸€ï¼šå»ºç«‹æ¸¬è©¦å‚™ä»½

```bash
# 1. åŸ·è¡Œå®Œæ•´å‚™ä»½
docker exec postgres-backup-logical /scripts/backup.sh full

# 2. ç¢ºèªå‚™ä»½å»ºç«‹æˆåŠŸ
docker exec postgres-backup-logical ls -la /backups/full/

# 3. é©—è­‰å‚™ä»½æª”æ¡ˆ
docker exec postgres-backup-logical /scripts/restore.sh verify /backups/full/full_XXXXXXXX_XXXXXX.sql.gz
```

### æ¼”ç·´æ­¥é©ŸäºŒï¼šæ¨¡æ“¬ç½é›£

```bash
# âš ï¸ ä»¥ä¸‹æ“ä½œæœƒåˆªé™¤è³‡æ–™ï¼Œåƒ…åœ¨æ¸¬è©¦ç’°å¢ƒåŸ·è¡Œï¼

# æ–¹æ¡ˆ Aï¼šåˆªé™¤éƒ¨åˆ†è³‡æ–™
docker exec postgres psql -U postgres -d mydb -c "DELETE FROM users WHERE id > 10;"

# æ–¹æ¡ˆ Bï¼šåˆªé™¤æ•´å€‹è¡¨æ ¼
docker exec postgres psql -U postgres -d mydb -c "DROP TABLE users CASCADE;"

# æ–¹æ¡ˆ Cï¼šåˆªé™¤æ•´å€‹è³‡æ–™åº« (æœ€æ¥µç«¯)
docker exec postgres psql -U postgres -c "DROP DATABASE mydb;"
docker exec postgres psql -U postgres -c "CREATE DATABASE mydb;"
```

### æ¼”ç·´æ­¥é©Ÿä¸‰ï¼šåŸ·è¡Œé‚„åŸ

```bash
# 1. åŸ·è¡Œé‚„åŸ
docker exec postgres-backup-logical /scripts/restore.sh restore /backups/full/full_XXXXXXXX_XXXXXX.sql.gz

# 2. é©—è­‰è³‡æ–™æ¢å¾©
docker exec postgres psql -U postgres -d mydb -c "SELECT COUNT(*) FROM users;"

# 3. æŠ½æ¨£æª¢æŸ¥è³‡æ–™å…§å®¹
docker exec postgres psql -U postgres -d mydb -c "SELECT * FROM users LIMIT 5;"
```

### æ¼”ç·´æ­¥é©Ÿå››ï¼šè¨˜éŒ„çµæœ

```markdown
## æ¼”ç·´å ±å‘Š

- æ—¥æœŸ: 2026-01-14
- åŸ·è¡Œäºº: [å§“å]
- å‚™ä»½æª”æ¡ˆ: full_20260114_120000.sql.gz
- å‚™ä»½å¤§å°: 15MB
- é‚„åŸè€—æ™‚: 2 åˆ† 30 ç§’
- çµæœ: âœ“ æˆåŠŸ
- å‚™è¨»: æ‰€æœ‰è³‡æ–™å®Œæ•´æ¢å¾©ï¼Œè¨˜éŒ„æ•¸ä¸€è‡´
```

### å»ºè­°æ¼”ç·´é »ç‡

| ç’°å¢ƒ | é »ç‡ | èªªæ˜ |
|------|------|------|
| é–‹ç™¼ç’°å¢ƒ | æ¯æœˆ | ç¢ºä¿å‚™ä»½æµç¨‹æ­£å¸¸ |
| æ¸¬è©¦ç’°å¢ƒ | æ¯é€± | æ¸¬è©¦æ–°ç‰ˆæœ¬å‚™ä»½ç›¸å®¹æ€§ |
| æ­£å¼ç’°å¢ƒ | æ¯å­£ | å®Œæ•´ç½é›£æ¢å¾©æ¼”ç·´ |

---

## â° æ’ç¨‹å»ºè­°

ä½¿ç”¨ Cron è¨­å®šè‡ªå‹•å‚™ä»½ï¼š

```bash
# ç·¨è¼¯ crontab
crontab -e

# PostgreSQL é‚è¼¯å‚™ä»½æ’ç¨‹
# æ¯é€±æ—¥å‡Œæ™¨ 2:00 å®Œå…¨å‚™ä»½
0 2 * * 0 docker exec postgres-backup-logical /scripts/backup.sh full >> /var/log/pg_logical_backup.log 2>&1

# æ¯æ—¥å‡Œæ™¨ 3:00 å¢é‡å‚™ä»½
0 3 * * * docker exec postgres-backup-logical /scripts/backup.sh incremental >> /var/log/pg_logical_backup.log 2>&1
```

---

## ğŸ“ ç›®éŒ„çµæ§‹

```
backups/
â”œâ”€â”€ full/           # å®Œå…¨å‚™ä»½
â”‚   â””â”€â”€ full_YYYYMMDD_HHMMSS.sql.gz[.enc]
â”œâ”€â”€ incremental/    # å¢é‡å‚™ä»½
â”‚   â””â”€â”€ incremental_YYYYMMDD_HHMMSS.sql.gz[.enc]
â”œâ”€â”€ remote/         # ç•°åœ°å‚™ä»½æš«å­˜
â”‚   â””â”€â”€ remote_YYYYMMDD_HHMMSS.sql.gz[.enc]
â””â”€â”€ logs/           # å‚™ä»½æ—¥èªŒ
    â””â”€â”€ backup_YYYYMMDD_HHMMSS.log
```

---

## âš ï¸ æ³¨æ„äº‹é …

- é‚è¼¯å‚™ä»½ä½¿ç”¨ `pg_dump`ï¼Œå¤§å‹è³‡æ–™åº«å‚™ä»½æ™‚é–“è¼ƒé•·
- ã€Œå¢é‡å‚™ä»½ã€å¯¦éš›ä¸Šæ˜¯å®Œæ•´ dumpï¼Œåƒ…ä»¥æ™‚é–“å€éš” (pg_dump ä¸æ”¯æ´çœŸæ­£å¢é‡)
- è‹¥éœ€è¦çœŸæ­£çš„å¢é‡å‚™ä»½å’Œ PITRï¼Œè«‹ä½¿ç”¨ [postgres_backup_physical](../postgres_backup_physical/)
- åŠ å¯†ä½¿ç”¨ OpenSSLï¼Œè«‹å¦¥å–„ä¿ç®¡åŠ å¯†å¯†ç¢¼
- é‚„åŸæ™‚éœ€è¦ä½¿ç”¨èˆ‡å‚™ä»½ç›¸åŒçš„åŠ å¯†ç®—æ³•å’Œå¯†ç¢¼

---

## ğŸ“š å»¶ä¼¸é–±è®€

- [PostgreSQL pg_dump å®˜æ–¹æ–‡ä»¶](https://www.postgresql.org/docs/current/app-pgdump.html)
- [PostgreSQL pg_restore å®˜æ–¹æ–‡ä»¶](https://www.postgresql.org/docs/current/app-pgrestore.html)
- [PostgreSQL Backup and Restore æœ€ä½³å¯¦è¸](https://www.postgresql.org/docs/current/backup.html)
